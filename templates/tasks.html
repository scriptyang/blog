{% extends 'init.html' %}
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <link rel="icon" type="image/png" href="/static/assets/img/favicon.ico">

    {% block head_js %}

        <style>
        select option{

line-height:30px;

height:30px;

margin:5px auto;

}
        </style>

    {% endblock %}

</head>
<body>


{% block page %}





    <div class="content">
        <div class="container-fluid">

            <div class="row">
                <div class="col-lg-4">

                    <div class="card">
                        <div class="content content-full-width">
                            <ul role="tablist" class="nav nav-tabs">
                                <li role="presentation" class="active">
                                    <a href="#local-task" data-toggle="tab">本地任务</a>
                                </li>
                                <li>
                                    <a href="#remote-task" data-toggle="tab">远程任务</a>
                                </li>
                                <li>
                                    <a href="#add-task-cmd" data-toggle="tab">命令增加</a>
                                </li>
                            </ul>


                            <div class="tab-content">
                                <div id="add-task-cmd" class="tab-pane">

                                    <div class="content text-center">
                                        <button class="btn btn-default btn-fill localadd">增加本地命令</button>
                                    </div>

                                    <div class="content text-center">
                                        <button class="btn btn-default btn-fill remoteadd">增加远程命令</button>
                                    </div>

                                </div>
                                <div id="local-task" class="tab-pane active">

                                    <form id="localtable">
                                        <div class="header">本地操作</div>
                                        <div class="content">

                                            <div class="form-group">
                                                <select name="local_cmd" class="selectpicker" data-title="Single Select"
                                                        data-style="btn-default btn-block"
                                                        data-menu-style="dropdown-blue">
                                                    {% for li in local_da %}
                                                        {% if forloop.first %}
                                                    <option value="{{ li.cmd }}" selected="selected">{{ li.cmd }}</option>
                                                        {% else %}
                                                        <option value="{{ li.cmd }} selected">{{ li.cmd }}</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="footer text-right">
                                                <button type="submit" class="btn btn-info btn-fill btn-wd">
                                                    提交
                                                </button>
                                            </div>
                                        </div>
                                    </form>

                                </div>
                                <div id="remote-task" class="tab-pane">
                                    <form id="remote_table">
                                        <div class="header">远程操作</div>
                                        <div class="content">
                                            <div class="form-group">
                                                远程主机：
                                                <select name="remote_addr" class="selectpicker" data-title="Single Select"
                                                        data-style="btn-default btn-block"
                                                        data-menu-style="dropdown-blue">

                                                    {% for li in remote_da %}
                                                        {% if forloop.first %}
                                                    <option value="{{ li.ip }}" selected="selected">{{ li.name }}({{ li.ip }})</option>
                                                        {% else %}
                                                        <option value="{{ li.ip }}">{{ li.name }}({{ li.ip }})</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                </select>
&nbsp;
                                                <select name="remote_cmd" class="selectpicker" data-title="Single Select"
                                                        data-style="btn-default btn-block"
                                                        data-menu-style="dropdown-blue">
                                                    {% for li in remote_task %}
                                                        {% if forloop.first %}
                                                    <option value="{{ li.cmd }}" selected="selected">{{ li.cmd }}</option>
                                                        {% else %}
                                                        <option value="{{ li.cmd }}">{{ li.cmd }}</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                </select>
                                            </div>

                                            <div class="footer text-right">
                                                <button type="submit" class="btn btn-info btn-fill btn-wd">
                                                    提交
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>

                        </div>
                    </div>


                </div>

                <div class="col-md-8">

                    <div class="card">

                        <div class="toolbar">
                            <!--        Here you can write extra buttons/actions for the toolbar              -->
                        </div>

                        <table id="bootstrap-table" class="table" data-sort-name="start_time" data-sort-order="desc">
                            <thead>
                            <th data-field="state" data-checkbox="true"></th>
                            <th data-field="id" data-sortable="true">id</th>
                            <th data-field="command">操作命令</th>
                            <th data-field="start_time">时间(Time)</th>
                            <th data-field="user">操作用户</th>
                            <th data-field="actions" class="td-actions text-right" data-events="operateEvents"
                                data-formatter="operateFormatter">Actions
                            </th>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div><!--  end card  -->
                </div> <!-- end col-md-12 -->
            </div> <!-- end row -->

        </div>
    </div>




{% endblock %}
</body>

{% block end_js %}
    <!--   Core JS Files and PerfectScrollbar library inside jquery.ui   -->
    <script src="/static/js/jquery.min.js" type="text/javascript"></script>
    <script src="/static/js/jquery-ui.min.js" type="text/javascript"></script>
    <script src="/static/js/bootstrap.min.js" type="text/javascript"></script>


    <!--  Forms Validations Plugin -->
    <script src="/static/js/jquery.validate.min.js"></script>

    <!--  Plugin for Date Time Picker and Full Calendar Plugin-->
    <script src="/static/js/moment.min.js"></script>

    <!--  Date Time Picker Plugin is included in this js file -->
    <script src="/static/js/bootstrap-datetimepicker.js"></script>

    <!--  Select Picker Plugin -->
    <script src="/static/js/bootstrap-selectpicker.js"></script>

    <!--  Checkbox, Radio, Switch and Tags Input Plugins -->
    <script src="/static/js/bootstrap-checkbox-radio-switch-tags.js"></script>

    <!--  Notifications Plugin    -->
    <script src="/static/js/bootstrap-notify.js"></script>

    <!-- Sweet Alert 2 plugin -->
    <script src="/static/js/sweetalert2.js"></script>

    <!-- Vector Map plugin -->
    <script src="/static/js/jquery-jvectormap.js"></script>

    <!-- Wizard Plugin    -->
    <script src="/static/js/jquery.bootstrap.wizard.min.js"></script>

    <!--  Bootstrap Table Plugin    -->
    <script src="/static/js/bootstrap-table.js"></script>

    <!--  Plugin for DataTables.net  -->
    <script src="/static/js/jquery.datatables.js"></script>

    <!--  Full Calendar Plugin    -->
    <script src="/static/js/fullcalendar.min.js"></script>

    <!-- Light Bootstrap Dashboard Core javascript and methods -->
    <script src="/static/js/light-bootstrap-dashboard.js"></script>

    <!--   Sharrre Library    -->
    <script src="/static/js/jquery.sharrre.js"></script>


    <script type="text/javascript">

        var $table = $('#bootstrap-table');

        function operateFormatter(value, row, index) {
            return [
                '<a rel="tooltip" title="View" class="btn btn-simple btn-info btn-icon table-action view" href="javascript:void(0)">',
                '<i class="fa fa-commenting"></i>',
                '</a>',
                '<a rel="tooltip" title="Remove" class="btn btn-simple btn-danger btn-icon table-action remove" href="javascript:void(0)">',
                '<i class="fa fa-remove"></i>',
                '</a>'
            ].join('');
        }

        $().ready(function () {
            window.operateEvents = {
                'click .view': function (e, value, row, index) {
                    info = JSON.stringify(row);

                    if (row['content'].length < 3) {
                        console.log('True');
                        swal({
                            html: '<div id="myDiv" style="text-align:left;background:#000;color:#66FF00">\n' +
                            '</div>',

                            showConfirmButton: false
                        });
                        loadXMLDoc();
                    }
                    else {
                        swal({
                            html: '<div style="text-align:left;background:#000;color:#66FF00">\n' +
                            row['content'] +
                            '</div>',

                            showConfirmButton: false
                        })
                    }
                },
                'click .edit': function (e, value, row, index) {

                    swal({

                            html: '<div class="form-group">\n' +
                            '    <label class="col-sm-2 control-label">备注</label>\n' +
                            '    <div class="col-sm-10">\n' +
                            '      <input type="text" class="form-control" id="remark" placeholder="" value="' + row['remark'] + '">\n' +
                            '    </div>\n' +
                            '  </div>' +
                            '</br>'
                        },
                        function () {
                            $.ajax({
                                    url: "{% url 'service_edit' %}",
                                    type: "post",
                                    dataType: 'text',
                                    data: {
                                        remark: document.getElementById('remark').value,
                                        id: row['id']
                                    },
                                    success: function (data) {
                                        if (document.getElementById('remark').value != row['remark']) {
                                            $table.bootstrapTable('refresh');

                                            var notify = $.notify({
                                                    icon: 'fa fa-server',
                                                    message: row['hostname'] + "： 内容正在更新。。。 ",
                                                },
                                                {
                                                    type: 'info'
                                                }
                                            );

                                            setTimeout(function () {
                                                notify.update('type', 'success')
                                                notify.update('message', row['hostname'] + "： 内容更新完成。");
                                            }, 3000);

                                        }
                                    },

                                }
                            );


                        },
                    );


                },
                'click .remove': function (e, value, row, index) {
                    $table.bootstrapTable('remove', {
                        field: 'id',
                        values: [row.id]
                    });

                    $.notify({
                            icon: 'pe-7s-trash',
                            message: row['hostname'] + "主机坐着飞机离开了！！！",
                        },
                        {
                            type: 'danger'
                        }
                    );

                    $.ajax({
                        url: "{% url 'drop_tables' %}",
                        type: 'post',
                        dataType: 'strings',
                        data: {
                            name: "tasks",
                            id: row.id
                        },
                        success: function () {
                            alert('ok')
                        }
                    })
                }
            };

            $table.bootstrapTable({
                toolbar: ".toolbar",
                url: '{% url "table_data" %}',
                method: 'get',
                queryParams: {"name": "task_info"},
                clickToSelect: true,
                showRefresh: true,
                search: true,
                showToggle: true,
                showColumns: true,
                pagination: true,
                searchAlign: 'left',
                pageSize: 8,
                clickToSelect: false,
                pageList: [8, 10, 25, 50, 100],


                formatShowingRows: function (pageFrom, pageTo, totalRows) {
                    //do nothing here, we don't want to show the text "showing x of y from..."
                },
                formatRecordsPerPage: function (pageNumber) {
                    return pageNumber + " rows visible";
                },
                icons: {
                    refresh: 'fa fa-refresh',
                    toggle: 'fa fa-th-list',
                    columns: 'fa fa-columns',
                    detailOpen: 'fa fa-plus-circle',
                    detailClose: 'fa fa-minus-circle'
                }
            });

            //activate the tooltips after the data table is initialized
            $('[rel="tooltip"]').tooltip();

            $(window).resize(function () {
                $table.bootstrapTable('resetView');
            });


        });


    </script>

    <script type="text/javascript">
        function loadXMLDoc()//ajax发送请求并显示
        {
            var xmlhttp;
            if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari
                xmlhttp = new XMLHttpRequest();
            }
            else {// code for IE6, IE5
                xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
            }
            xmlhttp.onreadystatechange = function () {
                if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                    if (xmlhttp.responseText.indexOf('SUCCESS') != -1) {
                        clearTimeout(t);
                        document.getElementById("myDiv").innerHTML = xmlhttp.responseText;
                    }
                    else {
                        document.getElementById("myDiv").innerHTML = xmlhttp.responseText;
                    }

                }
            }
            xmlhttp.open("GET", "{% url 'redis_test' %}", true);
            xmlhttp.send();
            t = setTimeout("loadXMLDoc()", 1000);
        }

        //先执行一次

    </script>



    <script type="text/javascript">

        $(document).ready(function () {
            $("#localtable").submit(function () {
                var command = $("select[name='local_cmd']").val();
                $.ajax({
                    url: "{% url 'command' %}",
                    type: "post",
                    data: {
                        level: command
                    },
                    success: function () {
                        $table.bootstrapTable('refresh');
                    }
                });
                return false;
            })
        })

    </script>

    <script type="text/javascript">

        $(document).ready(function () {
            $("#remote_table").submit(function () {
                var command = $("select[name='remote_cmd']").val();
                var addr = $("select[name='remote_addr']").val();
                $.ajax({
                    url: "{% url 'remote_task' %}",
                    type: "post",
                    data: {
                        cmd: command,
                        addr: addr
                    },
                    success: function () {
                        $table.bootstrapTable('refresh');
                    }
                });
                return false;
            })
        })

    </script>
    <script type="text/javascript">

        $(".localadd").click(function () {
            swal({
                html: '<input id="la_cmd" name="cmd" class="form-control">'
            },
            function () {
                $.ajax({
                    url: "{% url 'remote_task_set' %}",
                    type: "post",
                    data: {
                        cmd: document.getElementById('la_cmd').value,
                        remark: 'local'
                    },
                    success: function () {
                        $table.bootstrapTable('refresh');
                    }
                });
            })
        });

            $(".remoteadd").click(function () {
            swal({
                html: '<input id="la_cmd" name="cmd" class="form-control">'
            },
            function () {
                $.ajax({
                    url: "{% url 'remote_task_set' %}",
                    type: "post",
                    data: {
                        cmd: document.getElementById('la_cmd').value,
                        remark: 'remote'
                    },
                    success: function () {
                        $table.bootstrapTable('refresh');
                    }
                });
            })
        })

    </script>

{% endblock %}

</html>
